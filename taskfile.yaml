version: "3"
tasks:
  db:migrate:up:
    dotenv:
      - .env
    cmds:
      - migrate -source file://database/migrations -database "postgres://$CORTEX_POSTGRES_USER:$CORTEX_POSTGRES_PASSWORD@$CORTEX_POSTGRES_HOST:$CORTEX_POSTGRES_PORT/$CORTEX_POSTGRES_DATABASE?sslmode=disable" up

  db:migrate:create:
    dotenv:
      - .env
    cmds:
      - migrate create -ext sql -dir database/migrations {{.CLI_ARGS}}

  build:
    cmds:
      - go build -o build/cortex-api ./cmd/
    sources:
      - ./**/*.go
    generates:
      - build/cortex-api

  "build:prod":
    cmds:
      - go build -ldflags "-s -w" -o build/cortex-api ./cmd/
    sources:
      - ./**/*.go
    generates:
      - build/cortex-api

  run:
    interactive: true
    dotenv:
      - .env
    deps:
      - build
      - db:migrate:up
    cmds:
      - ./build/cortex-api {{.CLI_ARGS}}

  lint:
    cmds:
      - golangci-lint run

  lint:fix:
    cmds:
      - golangci-lint run --fix

  genmock:
    cmds:
      - mockery

  test:
    deps:
      - genmock
    cmds:
      - go test -coverprofile build/coverage ./...

  "coverage:html":
    deps:
      - test
    cmds:
      - go tool cover -html=build/coverage

  clean:
    cmds:
      - rm -r build/